// advanced_statements.js (Версия 50 - Добавлен расчет накопленного балла)

(async function () {
    'use strict';

    // --- ЗАЩИТА ОТ ДУБЛИРОВАНИЯ ---
    if (window.isAdvancedStatementsRunning) return;
    window.isAdvancedStatementsRunning = true;

    // --- КОНФИГУРАЦИЯ ---
    const TARGET_PATH_REGEX = /^\/learn\/reports\/student-performance\/.*\d+\/activity$/;
    const API_URL_TEMPLATE = "https://my.centraluniversity.ru/api/micro-lms/courses/{courseId}/student-performance";
    const COURSE_INFO_URL_TEMPLATE = "https://my.centraluniversity.ru/api/micro-lms/courses/{courseId}/exercises";

        // ... ВАШ ОБЪЕКТ COURSE_DATA (ОСТАВЬТЕ КАК ЕСТЬ) ...
    const COURSE_DATA = {
        "алгоритмы и структуры данных 2": {
            "домашние задания": {
            "weight": 0.15,
            "count": 9
            },
            "контрольная работа": {
            "weight": 0.2,
            "count": 2
            },
            "коллоквиум": {
            "weight": 0.25,
            "count": 1
            },
            "лабораторная работа": {
            "weight": 0.15,
            "count": 2
            },
            "экзамен": {
            "weight": 0.25,
            "count": 1
            }
        },
        "алгоритмы и структуры данных 2. продвинутый уровень": {
            "аудиторная работа на семинарах (бонусные баллы)": {
            "weight": 0.2,
            "count": 11
            },
            "домашние задания": {
            "weight": 0.3,
            "count": 11
            },
            "контрольная работа": {
            "weight": 0.2,
            "count": 1
            },
            "коллоквиум": {
            "weight": 0.3,
            "count": 1
            },
            "экзамен": {
            "weight": 0.2,
            "count": 1
            }
        },
        "архитектура компьютера и операционные системы 2": {
            "домашние задания": {
            "weight": 0.2,
            "count": 11
            },
            "контрольная работа": {
            "weight": 0.4,
            "count": 4
            },
            "экзамен": {
            "weight": 0.4,
            "count": 1
            }
        },
        "многопоточная синхронизация": {
            "проекты": {
            "weight": 0.3,
            "count": 3
            },
            "итоговый проект": {
            "weight": 0.4,
            "count": 1
            },
            "экзамен": {
            "weight": 0.3,
            "count": 1
            }
        },
        "дискретная математика": {
            "домашние задания": {
            "weight": 0.2,
            "count": 6
            },
            "контрольные работы": {
            "weight": 0.4,
            "count": 3
            },
            "экзамен": {
            "weight": 0.4,
            "count": 1
            }
        },
        "основы промышленной разработки": {
            "домашние задания": {
            "weight": 0.7,
            "count": 7
            },
            "контрольная работа": {
            "weight": 0.3,
            "count": 1
            }
        },
        "основы разработки на go": {
            "контрольные работы": {
            "weight": 0.3,
            "count": 3
            },
            "проект": {
            "weight": 0.4,
            "count": 1
            },
            "зачёт": {
            "weight": 0.3,
            "count": 1
            }
        },
        "информационная безопасность": {
            "лабораторные работы": {
            "weight": 0.5,
            "count": 15
            },
            "коллоквиум": {
            "weight": 0.25,
            "count": 1
            },
            "зачёт": {
            "weight": 0.25,
            "count": 1
            }
        },
        "методы дискретной оптимизации": {
            "домашние задания": {
            "weight": 0.15,
            "count": 14
            },
            "активность на семинаре": {
            "weight": 0.15,
            "count": 14
            },
            "контрольная работа": {
            "weight": 0.4,
            "count": 2
            },
            "итоговая работа": {
            "weight": 0.3,
            "count": 1
            }
        },
        "web-разработка": {
            "домашние задания": {
            "weight": 0.2,
            "count": 7
            },
            "проект": {
            "weight": 0.4,
            "count": 3
            },
            "зачёт": {
            "weight": 0.4,
            "count": 1
            },
            "бонусная активность": {
            "weight": 0.1,
            "count": 5
            }
        },
        "разработка на с++ 1": {
            "домашние задания": {
            "weight": 0.6,
            "count": 2
            },
            "проект": {
            "weight": 0.3,
            "count": 1
            },
            "контрольная работа": {
            "weight": 0.1,
            "count": 1
            }
        },
        "разработка на с++ 2": {
            "домашние задания": {
            "weight": 0.6,
            "count": 2
            },
            "проект": {
            "weight": 0.3,
            "count": 1
            },
            "контрольная работа": {
            "weight": 0.1,
            "count": 1
            }
        },
        "разработка на kotlin": {
            "домашние задания": {
            "weight": 0.4,
            "count": 7
            },
            "зачёт": {
            "weight": 0.6,
            "count": 1
            }
        },
        "rocq": {
            "домашние задания": {
            "weight": 1,
            "count": 7
            }
        },
        "введение в экономику. основной уровень": {
            "домашние задания": {
            "weight": 0.25,
            "count": 14
            },
            "аудиторная работа на семинаре": {
            "weight": 0.1,
            "count": 14
            },
            "мини-контрольные": {
            "weight": 0.15,
            "count": 7
            },
            "контрольная работа 1": {
            "weight": 0.25,
            "count": 1
            },
            "экзамен": {
            "weight": 0.25,
            "count": 1
            }
        },
        "основы бизнес-аналитики. основной уровень": {
            "аудиторная работа на семинаре": {
            "weight": 0.1,
            "count": 13
            },
            "квизы": {
            "weight": 0.1,
            "count": 5
            },
            "домашние задания": {
            "weight": 0.2,
            "count": 12
            },
            "групповой проект": {
            "weight": 0.2,
            "count": 1
            },
            "контрольная работа": {
            "weight": 0.15,
            "count": 1
            },
            "экзамен": {
            "weight": 0.25,
            "count": 1
            }
        },
        "введение в алгоритмы и структуры данных": {
            "домашние задания": {
            "weight": 0.2,
            "count": 12
            },
            "лабораторная работа": {
            "weight": 0.1,
            "count": 2
            },
            "контрольная работа": {
            "weight": 0.2,
            "count": 2
            },
            "коллоквиум": {
            "weight": 0.25,
            "count": 1
            },
            "экзамен": {
            "weight": 0.25,
            "count": 1
            },
            "аудиторная работа на семинарах (бонус)": {
            "weight": 0.1,
            "count": 15
            }
        },
        "макроэкономика i. основной уровень": {
            "домашние задания": {
            "weight": 0.2,
            "count": 13
            },
            "самостоятельные работы на семинарах": {
            "weight": 0.15,
            "count": 13
            },
            "аудиторная работа": {
            "weight": 0.15,
            "count": 15
            },
            "контрольная работа": {
            "weight": 0.2,
            "count": 1
            },
            "экзамен": {
            "weight": 0.3,
            "count": 1
            }
        },
        "основы финансов": {
            "домашние задания": {
            "weight": 0.25,
            "count": 11
            },
            "контрольная работа": {
            "weight": 0.2,
            "count": 1
            },
            "аудиторная работа на семинарах": {
            "weight": 0.15,
            "count": 15
            },
            "командный проект": {
            "weight": 0.2,
            "count": 1
            },
            "экзамен": {
            "weight": 0.2,
            "count": 1
            }
        },
        "основы маркетинга": {
            "домашние задания": {
            "weight": 0.3,
            "count": 13
            },
            "бизнес-игра": {
            "weight": 0.3,
            "count": 1
            },
            "экзамен": {
            "weight": 0.4,
            "count": 1
            }
        },
        "теория игр. основной уровень": {
            "домашние задания": {
            "weight": 0.2,
            "count": 13
            },
            "аудиторная работа на семинаре": {
            "weight": 0.15,
            "count": 15
            },
            "контрольная работа": {
            "weight": 0.3,
            "count": 1
            },
            "экзамен": {
            "weight": 0.35,
            "count": 1
            }
        },
        "финансы. основной уровень": {
            "домашние задания": {
            "weight": 0.3,
            "count": 5
            },
            "контрольные работы": {
            "weight": 0.15,
            "count": 3
            },
            "проект": {
            "weight": 0.15,
            "count": 1
            },
            "экзамен": {
            "weight": 0.4,
            "count": 1
            }
        },
        "эконометрика i. основной уровень": {
            "домашние задания": {
            "weight": 0.1,
            "count": 13
            },
            "самостоятельные работы / квизы": {
            "weight": 0.3,
            "count": 7
            },
            "контрольная работа": {
            "weight": 0.25,
            "count": 1
            },
            "экзамен": {
            "weight": 0.35,
            "count": 1
            }
        },
        "математическая статистика. основной уровень": {
            "домашние задания": {
            "weight": 0.15,
            "count": 15
            },
            "контесты": {
            "weight": 0.3,
            "count": 3
            },
            "контрольная работа": {
            "weight": 0.2,
            "count": 1
            },
            "экзамен": {
            "weight": 0.35,
            "count": 1
            }
        },
        "введение в экономику. продвинутый уровень": {
            "домашние задания": {
            "weight": 0.2,
            "count": 13
            },
            "аудиторная работа на  семинарах": {
            "weight": 0.15,
            "count": 13
            },
            "финальный проект": {
            "weight": 0.15,
            "count": 1
            },
            "дополнительная контрольная работа 1": {
            "weight": 0.25,
            "count": 1
            },
            "дополнительная контрольная работа 2": {
            "weight": 0.25,
            "count": 1
            }
        },
        "макроэкономика i. продвинутый уровень": {
            "домашние задания": {
            "weight": 0.2,
            "count": 13
            },
            "аудиторная работа на семинарах": {
            "weight": 0.2,
            "count": 10
            },
            "контрольная работа": {
            "weight": 0.15,
            "count": 1
            },
            "групповая работа со статьёй": {
            "weight": 0.1,
            "count": 1
            },
            "групповая работа с кейсом": {
            "weight": 0.15,
            "count": 1
            },
            "зачёт": {
            "weight": 0.2,
            "count": 1
            }
        },
        "математическая статистика. продвинутый уровень": {
            "коллоквиум": {
            "weight": 0,
            "count": 2
            },
            "домашние задания": {
            "weight": 0,
            "count": 10
            }
        },
        "основы бизнес-аналитики. продвинутый уровень": {
            "аудиторная работа на семинаре": {
            "weight": 0.3,
            "count": 14
            },
            "домашние задания": {
            "weight": 0.4,
            "count": 12
            },
            "кейс-чемпионат": {
            "weight": 0.3,
            "count": 1
            }
        },
        "теория игр. продвинутый уровень": {
            "аудиторная работа": {
            "weight": 0.3,
            "count": 15
            },
            "защита проекта": {
            "weight": 0.35,
            "count": 1
            },
            "проект": {
            "weight": 0.35,
            "count": 1
            }
        },
        "финансы. продвинутый уровень": {
            "аудиторная работа на семинарах": {
            "weight": 0.1,
            "count": 10
            },
            "кейсы": {
            "weight": 0.4,
            "count": 4
            },
            "финальный проект": {
            "weight": 0.5,
            "count": 1
            }
        },
        "эконометрика i. продвинутый уровень": {
            "домашние задания": {
            "weight": 0.15,
            "count": 10
            },
            "проектная работа": {
            "weight": 0.2,
            "count": 1
            },
            "контрольная работа": {
            "weight": 0.25,
            "count": 1
            },
            "самостоятельные работы / квизы": {
            "weight": 0.15,
            "count": 7
            },
            "зачёт": {
            "weight": 0.25,
            "count": 1
            }
        },
        "введение в искусственный интеллект. основной уровень": {
            "аудиторная работа (бонус)": {
            "weight": 0.1,
            "count": 15
            },
            "домашние задания": {
            "weight": 0.4,
            "count": 11
            },
            "кейсы": {
            "weight": 0.3,
            "count": 3
            },
            "коллоквиум": {
            "weight": 0.15,
            "count": 1
            },
            "зачёт": {
            "weight": 0.15,
            "count": 1
            },
            "бонусная активность": {
            "weight": 0.1,
            "count": 1
            }
        },
        "введение в статистику. основной уровень": {
            "домашние задания": {
            "weight": 0.15,
            "count": 14
            },
            "кейсы": {
            "weight": 0.2,
            "count": 4
            },
            "контрольные работы": {
            "weight": 0.25,
            "count": 3
            },
            "экзамен": {
            "weight": 0.4,
            "count": 1
            }
        },
        "алгоритмы и структуры данных 2 (ai link)": {
            "домашние задания": {
            "weight": 0.15,
            "count": 9
            },
            "контрольная работа": {
            "weight": 0.2,
            "count": 2
            },
            "коллоквиум": {
            "weight": 0.25,
            "count": 1
            },
            "лабораторная работа": {
            "weight": 0.15,
            "count": 2
            },
            "экзамен": {
            "weight": 0.25,
            "count": 1
            }
        },
        "алгоритмы и структуры данных 2. продвинутый уровень (ai link)": {
            "аудиторная работа на семинарах (бонусные баллы)": {
            "weight": 0.2,
            "count": 11
            },
            "домашние задания": {
            "weight": 0.3,
            "count": 11
            },
            "контрольная работа": {
            "weight": 0.2,
            "count": 1
            },
            "коллоквиум": {
            "weight": 0.3,
            "count": 1
            },
            "экзамен": {
            "weight": 0.2,
            "count": 1
            }
        },
        "базы данных": {
            "домашние задания": {
            "weight": 0.3,
            "count": 12
            },
            "контрольная работа": {
            "weight": 0.4,
            "count": 3
            },
            "проект": {
            "weight": 0.3,
            "count": 1
            }
        },
        "математическая статистика. основной уровень (ai link)": {
            "домашние задания": {
            "weight": 0.15,
            "count": 15
            },
            "контесты": {
            "weight": 0.3,
            "count": 3
            },
            "контрольная работа": {
            "weight": 0.2,
            "count": 1
            },
            "экзамен": {
            "weight": 0.35,
            "count": 1
            }
        },
        "deep learning": {
            "домашние задания": {
            "weight": 0.5,
            "count": 10
            },
            "творческое задание": {
            "weight": 0.3,
            "count": 2
            },
            "экзамен": {
            "weight": 0.2,
            "count": 1
            },
            "бонусная активность": {
            "weight": 0.1,
            "count": 15
            }
        },
        "методы дискретной оптимизации (ai link)": {
            "домашние задания": {
            "weight": 0.15,
            "count": 14
            },
            "активность на семинаре": {
            "weight": 0.15,
            "count": 14
            },
            "контрольная работа": {
            "weight": 0.4,
            "count": 2
            },
            "итоговая работа": {
            "weight": 0.3,
            "count": 1
            }
        },
        "введение в статистику. продвинутый уровень": {
            "домашние задания": {
            "weight": 0,
            "count": 14
            },
            "кейсы": {
            "weight": 0,
            "count": 4
            },
            "контрольные работы": {
            "weight": 0,
            "count": 3
            },
            "итоговая работа": {
            "weight": 0,
            "count": 1
            }
        },
        "введение в искусственный интеллект. продвинутый уровень": {
            "аудиторная работа на семинарах": {
            "weight": 0.1,
            "count": 15
            },
            "домашние задания": {
            "weight": 0.7,
            "count": 11
            },
            "контесты": {
            "weight": 0.3,
            "count": 3
            }
        },
        "основы математического анализа и линейной алгебры 2": {
            "домашние задания": {
            "weight": 0.15,
            "count": 15
            },
            "контест": {
            "weight": 0.2,
            "count": 11
            },
            "проект": {
            "weight": 0.1,
            "count": 2
            },
            "контрольная работа": {
            "weight": 0.25,
            "count": 4
            },
            "экзамен": {
            "weight": 0.3,
            "count": 1
            }
        },
        "математический анализ 2. основной уровень": {
            "домашние задания": {
            "weight": 0.2,
            "count": 14
            },
            "коллоквиум": {
            "weight": 0.15,
            "count": 1
            },
            "контрольные": {
            "weight": 0.3,
            "count": 3
            },
            "экзамен": {
            "weight": 0.35,
            "count": 1
            }
        },
        "математический анализ 2. пилотный поток": {
            "домашние задания": {
            "weight": 0.2,
            "count": 14
            },
            "контрольная работа": {
            "weight": 0.2,
            "count": 2
            },
            "коллоквиум": {
            "weight": 0.3,
            "count": 1
            },
            "экзамен": {
            "weight": 0.3,
            "count": 1
            }
        },
        "линейная алгебра и геометрия 2": {
            "домашние задания": {
            "weight": 0.15,
            "count": 14
            },
            "аудиторная работа": {
            "weight": 0.1,
            "count": 1
            },
            "контрольная работа": {
            "weight": 0.2,
            "count": 1
            },
            "коллоквиум": {
            "weight": 0.25,
            "count": 1
            },
            "экзамен": {
            "weight": 0.3,
            "count": 1
            }
        },
        "линейная алгебра и геометрия 2. пилотный поток": {
            "домашние задания": {
            "weight": 0.1,
            "count": 14
            },
            "индивидуальное домашнее задание": {
            "weight": 0.2,
            "count": 4
            },
            "контрольная работа": {
            "weight": 0.2,
            "count": 1
            },
            "коллоквиум": {
            "weight": 0.2,
            "count": 1
            },
            "экзамен": {
            "weight": 0.3,
            "count": 1
            }
        },
        "алгебра": {
            "домашние задания": {
            "weight": 0.3,
            "count": 14
            },
            "контрольные работы": {
            "weight": 0.3,
            "count": 1
            },
            "зачёт": {
                "weight": 0.4,
                "count": 1
            }
        },
        "дополнительные главы математического анализа": {
            "домашние задания": {
            "weight": 0.2,
            "count": 15
            },
            "контрольная работа": {
            "weight": 0.3,
            "count": 2
            },
            "коллоквиум": {
            "weight": 0.15,
            "count": 1
            },
            "итоговая работа": {
            "weight": 0.35,
            "count": 1
            }
        },
        "математический анализ 2. продвинутый уровень": {
            "домашние задания": {
            "weight": 0.2,
            "count": 14
            },
            "коллоквиум": {
            "weight": 0.15,
            "count": 1
            },
            "контрольные": {
            "weight": 0.3,
            "count": 3
            },
            "итоговая работа": {
            "weight": 0.35,
            "count": 1
            }
        },
        "бизнес-студия": {
            "домашние задания": {
            "weight": 0.2,
            "count": 7
            },
            "промежуточная защита проекта": {
            "weight": 0.35,
            "count": 2
            },
            "итоговая защита проекта": {
            "weight": 0.45,
            "count": 1
            }
        },
        "искусство и наука": {
            "защита первой части проекта": {
            "weight": 0.15,
            "count": 1
            },
            "защита второй части проекта": {
            "weight": 0.15,
            "count": 1
            },
            "домашние задания": {
            "weight": 0.3,
            "count": 5
            },
            "защита третьей части проекта": {
            "weight": 0.2,
            "count": 1
            },
            "аудиторная работа": {
            "weight": 0.2,
            "count": 15
            }
        },
        "научная студия. в поисках нейтронов": {
            "аудиторная работа на семинарах": {
            "weight": 0.1,
            "count": 10
            },
            "домашние задания": {
            "weight": 0.3,
            "count": 10
            },
            "отчёт": {
            "weight": 0.4,
            "count": 1
            },
            "хакатон": {
            "weight": 0.2,
            "count": 1
            }
        },
        "научная студия. лечение на гамма-ноже": {
            "аудиторная работа на семинарах": {
            "weight": 0.1,
            "count": 10
            },
            "домашние задания": {
            "weight": 0.3,
            "count": 10
            },
            "отчёт": {
            "weight": 0.4,
            "count": 1
            },
            "хакатон": {
            "weight": 0.2,
            "count": 1
            }
        },
        "научная студия. переменные звезды": {
            "аудиторная работа на семинарах": {
            "weight": 0.1,
            "count": 10
            },
            "домашние задания": {
            "weight": 0.3,
            "count": 10
            },
            "отчёт": {
            "weight": 0.4,
            "count": 1
            },
            "хакатон": {
            "weight": 0.2,
            "count": 1
            }
        },
        "научная студия. перколяция": {
            "аудиторная работа на семинарах": {
            "weight": 0.1,
            "count": 10
            },
            "домашние задания": {
            "weight": 0.3,
            "count": 10
            },
            "отчёт": {
            "weight": 0.4,
            "count": 1
            },
            "хакатон": {
            "weight": 0.2,
            "count": 1
            }
        },
        "научная студия. поиск экспортных рынков": {
            "аудиторная работа на семинарах": {
            "weight": 0.1,
            "count": 10
            },
            "домашние задания": {
            "weight": 0.3,
            "count": 10
            },
            "отчёт": {
            "weight": 0.4,
            "count": 1
            },
            "хакатон": {
            "weight": 0.2,
            "count": 1
            }
        },
        "научная студия. стратегия управления кадрами": {
            "аудиторная работа на семинарах": {
            "weight": 0.1,
            "count": 10
            },
            "домашние задания": {
            "weight": 0.3,
            "count": 10
            },
            "отчёт": {
            "weight": 0.4,
            "count": 1
            },
            "хакатон": {
            "weight": 0.2,
            "count": 1
            }
        },
        "научная студия. умный дом": {
            "аудиторная работа на семинарах": {
            "weight": 0.1,
            "count": 10
            },
            "домашние задания": {
            "weight": 0.3,
            "count": 10
            },
            "отчёт": {
            "weight": 0.4,
            "count": 1
            },
            "хакатон": {
            "weight": 0.2,
            "count": 1
            }
        },
        "студия компьютерных наук": {
            "домашние задания": {
            "weight": 0.25,
            "count": 1
            },
            "аудиторная работа": {
            "weight": 0.15,
            "count": 1
            },
            "контрольная работа (midterm)": {
            "weight": 0.3,
            "count": 1
            },
            "контрольная работа (final)": {
            "weight": 0.3,
            "count": 1
            }
        },
        "философия и наука": {
            "аудиторная работа на лекциях": {
            "weight": 0.2,
            "count": 15
            },
            "домашние задания": {
            "weight": 0.2,
            "count": 9
            },
            "итоговый проект": {
            "weight": 0.6,
            "count": 1
            }
        },
        "алгоритмы принятия решений": {
            "активность на занятиях": {
            "weight": 0.6,
            "count": 15
            },
            "домашние задания": {
            "weight": 0.2,
            "count": 8
            },
            "итоговый проект": {
            "weight": 0.2,
            "count": 1
            }
        },
        "командная работа по agile": {
            "активность на занятиях": {
            "weight": 0.3,
            "count": 14
            },
            "домашние задания": {
            "weight": 0.3,
            "count": 14
            },
            "срез знаний": {
            "weight": 0.1,
            "count": 1
            },
            "итоговый проект": {
            "weight": 0.3,
            "count": 1
            }
        },
        "креативные техники решения задач": {
            "активность на занятиях": {
            "weight": 0.2,
            "count": 7
            },
            "домашние задания": {
            "weight": 0.3,
            "count": 4
            },
            "срезы знаний": {
            "weight": 0.1,
            "count": 4
            },
            "итоговый проект": {
            "weight": 0.4,
            "count": 1
            }
        },
        "публичные выступления и основы презентации": {
            "активность на занятиях": {
            "weight": 0.25,
            "count": 15
            },
            "публичные выступления на занятиях": {
            "weight": 0.5,
            "count": 10
            },
            "финальное публичное выступление": {
            "weight": 0.25,
            "count": 1
            }
        },
        "системное и критическое мышление": {
            "активность на занятиях": {
            "weight": 0.6,
            "count": 15
            },
            "домашние задания": {
            "weight": 0.2,
            "count": 8
            },
            "итоговый проект": {
            "weight": 0.2,
            "count": 1
            }
        },
        "стратегическое мышление": {
            "срезы знаний": {
            "weight": 0.35,
            "count": 15
            },
            "кейсы": {
            "weight": 0.35,
            "count": 5
            },
            "итоговый проект": {
            "weight": 0.3,
            "count": 1
            }
        },
        "стресс-менеджмент и эмоциональный интеллект": {
            "активность на занятиях": {
            "weight": 0.4,
            "count": 7
            },
            "домашние задания": {
            "weight": 0.2,
            "count": 7
            },
            "итоговый проект": {
            "weight": 0.4,
            "count": 1
            }
        },
        "работа в команде и коллаборация": {
            "активность на занятиях": {
            "weight": 0.3,
            "count": 15
            },
            "мини-проекты": {
            "weight": 0.3,
            "count": 15
            },
            "домашние задания": {
            "weight": 0.1,
            "count": 10
            },
            "итоговый проект": {
            "weight": 0.3,
            "count": 1
            }
        },
        "управление ресурсами: личная эффективность": {
            "активность на занятиях": {
            "weight": 0.45,
            "count": 8
            },
            "домашние задания": {
            "weight": 0.3,
            "count": 8
            },
            "итоговый проект": {
            "weight": 0.25,
            "count": 1
            }
        },
        "целеполагание, планирование и самоорганизация": {
            "домашние задания": {
            "weight": 0.35,
            "count": 30
            },
            "активность на занятиях": {
            "weight": 0.35,
            "count": 6
            },
            "итоговое портфолио": {
            "weight": 0.3,
            "count": 1
            }
        },
        "ясность в текстах": {
            "активность на занятиях": {
            "weight": 0.3,
            "count": 15
            },
            "домашние задания": {
            "weight": 0.35,
            "count": 10
            },
            "мини-проекты": {
            "weight": 0.35,
            "count": 5
            }
        },
        "физкультура и спорт": null,
        "английский язык 101s2": {
            "домашние задания": {
            "weight": 0.2,
            "count": 13
            },
            "аудиторная работа на семинарах": {
            "weight": 0.25,
            "count": 28
            },
            "контрольная работа": {
            "weight": 0.15,
            "count": 2
            },
            "зачёт с оценкой": {
            "weight": 0.4,
            "count": 1
            }
        },
        "английский язык 102s2": {
            "домашние задания": {
            "weight": 0.2,
            "count": 13
            },
            "аудиторная работа на семинарах": {
            "weight": 0.25,
            "count": 28
            },
            "контрольная работа": {
            "weight": 0.15,
            "count": 2
            },
            "зачёт с оценкой": {
            "weight": 0.4,
            "count": 1
            }
        },
        "английский язык 103s2": {
            "домашние задания": {
            "weight": 0.2,
            "count": 12
            },
            "аудиторная работа на семинарах": {
            "weight": 0.25,
            "count": 29
            },
            "контрольная работа": {
            "weight": 0.15,
            "count": 3
            },
            "зачёт с оценкой": {
            "weight": 0.4,
            "count": 1
            }
        },
        "английский язык 103s2b": {
            "домашние задания": {
            "weight": 0.2,
            "count": 12
            },
            "аудиторная работа на семинарах": {
            "weight": 0.25,
            "count": 29
            },
            "контрольная работа": {
            "weight": 0.15,
            "count": 3
            },
            "зачёт с оценкой": {
            "weight": 0.4,
            "count": 1
            }
        },
        "английский язык 104s2": {
            "домашние задания": {
            "weight": 0.2,
            "count": 13
            },
            "аудиторная работа": {
            "weight": 0.25,
            "count": 28
            },
            "контрольная работа": {
            "weight": 0.15,
            "count": 2
            },
            "зачёт с оценкой": {
            "weight": 0.4,
            "count": 1
            }
        },
        "английский язык 104s2b": {
            "домашние задания": {
            "weight": 0.2,
            "count": 13
            },
            "аудиторная работа": {
            "weight": 0.25,
            "count": 28
            },
            "контрольная работа": {
            "weight": 0.15,
            "count": 2
            },
            "зачёт с оценкой": {
            "weight": 0.4,
            "count": 1
            }
        },
        "английский язык 105s2": {
            "домашние задания": {
            "weight": 0.2,
            "count": 13
            },
            "аудиторная работа": {
            "weight": 0.25,
            "count": 29
            },
            "контрольная работа": {
            "weight": 0.15,
            "count": 2
            },
            "зачёт с оценкой": {
            "weight": 0.4,
            "count": 1
            }
        },
        "английский язык 105s2b": {
            "домашние задания": {
            "weight": 0.2,
            "count": 13
            },
            "аудиторная работа": {
            "weight": 0.25,
            "count": 29
            },
            "контрольная работа": {
            "weight": 0.15,
            "count": 2
            },
            "зачёт с оценкой": {
            "weight": 0.4,
            "count": 1
            }
        },
        "английский язык 202s4": {
            "домашние задания": {
            "weight": 0.2,
            "count": 13
            },
            "аудиторная работа": {
            "weight": 0.25,
            "count": 29
            },
            "контрольная работа": {
            "weight": 0.15,
            "count": 3
            },
            "экзамен": {
            "weight": 0.4,
            "count": 1
            }
        },
        "английский язык 203s4": {
            "домашние задания": {
            "weight": 0.2,
            "count": 13
            },
            "аудиторная работа на семинарах": {
            "weight": 0.25,
            "count": 30
            },
            "контрольная работа": {
            "weight": 0.15,
            "count": 4
            },
            "экзамен": {
            "weight": 0.4,
            "count": 1
            }
        },
        "английский язык 204s4": {
            "домашние задания": {
            "weight": 0.2,
            "count": 13
            },
            "аудиторная работа на семинарах": {
            "weight": 0.25,
            "count": 28
            },
            "контрольная работа": {
            "weight": 0.15,
            "count": 3
            },
            "экзамен": {
            "weight": 0.4,
            "count": 1
            }
        },
        "английский язык 204s4b": {
            "домашние задания": {
            "weight": 0.2,
            "count": 13
            },
            "аудиторная работа на семинарах": {
            "weight": 0.25,
            "count": 28
            },
            "контрольная работа": {
            "weight": 0.15,
            "count": 3
            },
            "экзамен": {
            "weight": 0.4,
            "count": 1
            }
        },
        "история россии": {
            "домашние задания": {
            "weight": 0.15,
            "count": 8
            },
            "контрольная работа": {
            "weight": 0.15,
            "count": 1
            },
            "индивидуальный проект": {
            "weight": 0.3,
            "count": 1
            },
            "семинары": {
            "weight": 0.4,
            "count": 14
            }
        },
        "этика. право. ии": null,
        "как понимать кино?": null
        };


    // --- СЕЛЕКТОРЫ ---
    const CONTAINER_ID = "advanced-statements-container";
    const PARENT_COMPONENT_SELECTOR = "cu-student-course-performance";
    const TABLE_WRAPPER_SELECTOR = "cu-student-activity-performance-table"; 
    const ORIGINAL_TABLE_SELECTOR = "table.cu-table";
    const STYLE_ID = "adv-statements-layout-styles";

    let retryTimer = null;

    // --- ЛОГИКА ПОИСКА ---
    function levenshteinDistance(s1, s2) {
        s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
        const costs = [];
        for (let i = 0; i <= s1.length; i++) {
            let lastValue = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i === 0) { costs[j] = j; } else {
                    if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) { newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1; }
                        costs[j - 1] = lastValue; lastValue = newValue;
                    }
                }
            }
            if (i > 0) costs[s2.length] = lastValue;
        }
        return costs[s2.length];
    }

    function calculateSimilarity(s1, s2) {
        let longer = s1; let shorter = s2;
        if (s1.length < s2.length) { longer = s2; shorter = s1; }
        const longerLength = longer.length;
        if (longerLength === 0) return 1.0;
        return (longerLength - levenshteinDistance(longer, shorter)) / parseFloat(longerLength);
    }

    function findBestCourseMatch(apiCourseName, courseData) {
        if (!apiCourseName) return null;
        const apiNameLower = apiCourseName.toLowerCase().trim();
        for (const key in courseData) { if (key.toLowerCase().trim() === apiNameLower) return courseData[key]; }
        let bestPrefixMatch = null; let longestPrefix = 0;
        for (const key in courseData) {
            const keyLower = key.toLowerCase().trim();
            if (apiNameLower.startsWith(keyLower) && keyLower.length > longestPrefix) { bestPrefixMatch = key; longestPrefix = keyLower.length; }
        }
        if (bestPrefixMatch) return courseData[bestPrefixMatch];
        let bestSimilarityMatch = null; let maxScore = 0.0;
        for (const key in courseData) {
            const keyLower = key.toLowerCase().trim(); const score = calculateSimilarity(apiNameLower, keyLower);
            if (score > maxScore) { maxScore = score; bestSimilarityMatch = key; }
        }
        if (maxScore > 0.8) return courseData[bestSimilarityMatch];
        const processedApiName = apiNameLower.replace(/(?:\s+|\.|_)(?:поток|группа|group|stream)?\s*\d+$/, '').trim();
        if (processedApiName !== apiNameLower) {
             for (const key in courseData) { if (key.toLowerCase().trim() === processedApiName) return courseData[key]; }
        }
        return null;
    }

    // --- ГЛАВНАЯ ФУНКЦИЯ ---

    async function tryRenderModule() {
        if (!TARGET_PATH_REGEX.test(window.location.pathname)) {
            resetState();
            return;
        }

        if (document.getElementById(CONTAINER_ID)) {
            const container = document.getElementById(CONTAINER_ID);
            if (!document.body.contains(container)) {
                resetState();
            } else {
                return;
            }
        }

        const parentComponent = document.querySelector(PARENT_COMPONENT_SELECTOR);
        const tableWrapper = document.querySelector(TABLE_WRAPPER_SELECTOR);
        const originalTable = tableWrapper ? tableWrapper.querySelector(ORIGINAL_TABLE_SELECTOR) : null;

        if (!parentComponent || !tableWrapper || !originalTable) {
            clearTimeout(retryTimer);
            retryTimer = setTimeout(tryRenderModule, 500);
            return;
        }

        console.log("[Adv. Statements] Таблица найдена. Запуск расчета...");
        try {
            const { endOfCourseCalcEnabled } = await browser.storage.sync.get('endOfCourseCalcEnabled');
            const calculationMode = endOfCourseCalcEnabled ? 'endOfCourse' : 'current';
            const courseId = getCourseId();
            const courseName = await fetchCourseName(courseId);
            const courseConfig = findBestCourseMatch(courseName, COURSE_DATA);

            const tasks = await fetchPerformanceData(courseId);
            const calculatedData = calculateScores(tasks, courseConfig, calculationMode);
            
            renderSidebar(calculatedData, parentComponent, tableWrapper, calculationMode);
        } catch (error) {
            console.error("[Adv. Statements] Ошибка:", error);
            clearTimeout(retryTimer);
            retryTimer = setTimeout(tryRenderModule, 1000);
        }
    }

    // --- РАСЧЕТ БАЛЛОВ ---
    function calculateScores(tasks, courseConfig, mode) {
        const activities = new Map();
        tasks.forEach(task => {
            if (!task.activity) return;
            const nameLower = task.activity.name.trim().toLowerCase();
            if (!activities.has(nameLower)) { activities.set(nameLower, { name: task.activity.name, weight: task.activity.weight, scores: [], sum: 0, }); }
            if (task.score !== null) { const activity = activities.get(nameLower); activity.scores.push(task.score); activity.sum += task.score; }
        });

        const finalActivities = new Map();
        const apiActivityNames = Array.from(activities.keys());

        if (mode === 'endOfCourse' && courseConfig) {
            for (const configName in courseConfig) {
                const configNameLower = configName.toLowerCase();
                let bestMatchName = null; let maxScore = 0.0;
                apiActivityNames.forEach(apiName => { const score = calculateSimilarity(configNameLower, apiName); if (score > maxScore) { maxScore = score; bestMatchName = apiName; } });
                if (bestMatchName && maxScore > 0.7) { finalActivities.set(configNameLower, activities.get(bestMatchName)); } else {
                    const displayName = configName.charAt(0).toUpperCase() + configName.slice(1);
                    finalActivities.set(configNameLower, { name: displayName, weight: courseConfig[configName].weight, scores: [], sum: 0, });
                }
            }
        } else { activities.forEach((value, key) => finalActivities.set(key, value)); }

        const calculatedActivities = [];
        let totalWeightedScore = 0; 
        let totalWeight = 0;
        let totalMaxScoreSoFar = 0; // Для расчета "Максимума на данный момент"

        for (const [nameLower, data] of finalActivities.entries()) {
            let activityConfig = null;
            if (courseConfig) {
                let bestMatchKey = null; let maxScore = 0.0;
                for (const configKey in courseConfig) { const score = calculateSimilarity(nameLower, configKey.toLowerCase().trim()); if (score > maxScore) { maxScore = score; bestMatchKey = configKey; } }
                if (maxScore > 0.7) { activityConfig = courseConfig[bestMatchKey]; }
            }
            
            const actualCount = data.scores.length;
            let divisor; let countDisplay; let finalWeight = data.weight;
            if (activityConfig && activityConfig.weight > 0) { finalWeight = activityConfig.weight; }
            
            if (mode === 'endOfCourse' && activityConfig && activityConfig.count > 0) {
                divisor = activityConfig.count; 
                countDisplay = `${actualCount} / ${activityConfig.count}`;
                
                // Расчет "Накопленного"
                // Если мы знаем общее кол-во задач (divisor), то "текущий взвешенный" = (сумма / divisor) * вес
                // "Макс. возможный взвешенный" = (кол-во сданных * 10 / divisor) * вес
                const maxPointsPerTask = 10; // Стандарт CU
                const maxContributionSoFar = (actualCount * maxPointsPerTask / divisor) * finalWeight;
                totalMaxScoreSoFar += maxContributionSoFar;

            } else {
                // Если режим "по факту", divisor = actualCount
                divisor = actualCount; 
                countDisplay = `${actualCount}`;
                
                // В этом режиме "Макс возможный" = вес * 10 (если считать, что все сданные были бы на 10)
                if (actualCount > 0) {
                    totalMaxScoreSoFar += finalWeight * 10; 
                }
            }
            
            const avg = (divisor > 0) ? (data.sum / divisor) : 0;
            const weightedScore = avg * finalWeight;

            calculatedActivities.push({ name: data.name, averageScore: avg.toFixed(2), weight: finalWeight, weightedScore: weightedScore.toFixed(2), countDisplay: countDisplay, });
            totalWeightedScore += weightedScore; totalWeight += finalWeight;
        }

        return { 
            activities: calculatedActivities.sort((a, b) => a.name.localeCompare(b.name)), 
            totalWeightedScore: totalWeightedScore.toFixed(2), 
            totalWeight: totalWeight,
            totalMaxScoreSoFar: totalMaxScoreSoFar.toFixed(2),
            hasConfig: !!courseConfig
        };
    }

    // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---

    function getCourseId() { 
        const match = window.location.pathname.match(/\/(\d+)\/activity/); 
        return match ? match[1] : null; 
    }
    
    async function fetchCourseName(courseId) {
        if (!courseId) return null;
        try { const response = await fetch(COURSE_INFO_URL_TEMPLATE.replace('{courseId}', courseId)); if (!response.ok) return null; const data = await response.json(); return data.name ? data.name.trim() : null; } catch (error) { return null; }
    }

    async function fetchPerformanceData(courseId) { if (!courseId) return []; try { const response = await fetch(API_URL_TEMPLATE.replace('{courseId}', courseId)); if (!response.ok) throw new Error(); const data = await response.json(); return data.tasks || []; } catch (error) { return []; } }

    function resetState() {
        const component = document.getElementById(CONTAINER_ID);
        if (component) component.remove();
        
        // --- ДОБАВЛЕНО: Удаляем стили, чтобы вернуть страницу в обычный вид ---
        const styleElement = document.getElementById(STYLE_ID);
        if (styleElement) styleElement.remove();
        // ---------------------------------------------------------------------

        clearTimeout(retryTimer);
        retryTimer = null;
    }

    function renderSidebar(data, parentComponent, tableWrapper, calculationMode) {
        if (document.getElementById(CONTAINER_ID)) document.getElementById(CONTAINER_ID).remove();
        
        if (!document.getElementById(STYLE_ID)) {
            const styleSheet = document.createElement("style");
            styleSheet.id = STYLE_ID;
            styleSheet.innerHTML = `${PARENT_COMPONENT_SELECTOR} { position: relative !important; padding-right: 580px !important; box-sizing: border-box !important; } .adv-table-count-col { text-align: center; width: 80px; } #${CONTAINER_ID} .cu-table th.adv-table-count-col, #${CONTAINER_ID} .cu-table td.adv-table-count-col { border-right: 1px solid rgba(255, 255, 255, 0.12); }`.replace(/\s\s+/g, ' ').trim();
            document.head.appendChild(styleSheet);
        }

        const originalTable = tableWrapper.querySelector(ORIGINAL_TABLE_SELECTOR);
        if (!originalTable) return;
        
        const rowTemplate = originalTable.querySelector('tbody tr');
        if (!rowTemplate) return;

        const clonedTable = originalTable.cloneNode(true);
        clonedTable.querySelectorAll('thead th cu-tooltip').forEach(tip => tip.remove());
        
        const headerRow = clonedTable.querySelector('thead tr');
        if (headerRow) {
            const firstHeaderCell = headerRow.querySelector('th');
            const newHeaderCell = document.createElement('th');
            newHeaderCell.textContent = 'Количество';
            newHeaderCell.classList.add('adv-table-count-col');
            firstHeaderCell.insertAdjacentElement('afterend', newHeaderCell);
        }

        const tbody = clonedTable.querySelector('tbody');
        tbody.innerHTML = '';
        data.activities.forEach(act => {
            const newRow = rowTemplate.cloneNode(true);
            const firstCell = newRow.querySelector('td');
            const countCell = document.createElement('td');
            countCell.textContent = act.countDisplay;
            countCell.classList.add('adv-table-count-col');
            firstCell.insertAdjacentElement('afterend', countCell);

            newRow.querySelector('.column-activity').textContent = act.name;
            newRow.querySelector('.column-average-score .signed-cell__average-score').textContent = act.averageScore;
            newRow.querySelector('.column-weight .signed-cell > span').textContent = `${Math.round(act.weight * 100)}%`;
            newRow.querySelector('.column-total > span').textContent = act.weightedScore;
            tbody.appendChild(newRow);
        });
        
        const footerCells = clonedTable.querySelectorAll('tfoot td');
        const footerRow = clonedTable.querySelector('tfoot tr');
        
        // Добавляем пустую ячейку для колонки "Количество" в футер
        if (footerRow && footerCells.length > 0) {
             const firstFooterCell = footerRow.querySelector('td');
             const emptyFooterCell = document.createElement('td');
             firstFooterCell.insertAdjacentElement('afterend', emptyFooterCell);
        }

        const updatedFooterCells = clonedTable.querySelectorAll('tfoot td');
        if (updatedFooterCells.length >= 5) {
            updatedFooterCells[0].innerHTML = `<span cutext="s-bold" class="font-text-s-bold">Итог</span>`;
            updatedFooterCells[3].textContent = `${Math.round(data.totalWeight * 100)}%`;
            updatedFooterCells[4].querySelector('span').textContent = data.totalWeightedScore;
        }
        
        if (data.hasConfig) {
            const accumulationRow = document.createElement('tr');
            
            // Расчет процента
            const actual = parseFloat(data.totalWeightedScore);
            const max = parseFloat(data.totalMaxScoreSoFar);
            let percentageStr = "0%";
            if (max > 0) {
                percentageStr = Math.round((actual / max) * 100) + "%";
            }

            accumulationRow.innerHTML = `
                <td colspan="5" style="text-align: center; padding: 12px; color: #aaa; font-size: 13px; border-top: 1px solid rgba(255,255,255,0.05);">
                    Накоплено на данный момент: <b style="color: #fff">${data.totalWeightedScore}</b> / <b style="color: #fff">${data.totalMaxScoreSoFar}</b> (${percentageStr})
                </td>
            `;
            clonedTable.querySelector('tfoot').appendChild(accumulationRow);
        }
        // -------------------------------------
        // -------------------------------------

        const container = document.createElement("div");
        container.id = CONTAINER_ID;
        
        const topOffset = tableWrapper.offsetTop || 0;
        container.style.cssText = `position: absolute; top: ${topOffset}px; right: 24px; width: 540px;`;
        
        const explanation = calculationMode === 'endOfCourse' ? 'Средний балл вычисляется по <b>всем</b> заданиям, запланированным в курсе (согласно настройкам плагина). Задания без оценки учитываются как 0.' : 'Средний балл вычисляется только по тем заданиям, где <b>уже выставлена оценка</b> (включая 0). Задания без оценки не учитываются.';
        container.innerHTML = `<fieldset class="t-content" style="border: none; padding: 0;"></fieldset><p style="font-size: 12px; color: #888; margin-top: 10px; line-height: 1.5;"><b>Принцип расчёта этой таблицы (справа):</b><br>${explanation}<br><br><b>Принцип расчёта ведомости LMS (слева):</b><br>Средний балл считается по <b>всем открытым</b> заданиям в рамках одной активности.</p>`;
        container.querySelector('fieldset').appendChild(clonedTable);
        parentComponent.appendChild(container); 
    }

    // --- ОБРАБОТЧИК НАВИГАЦИИ ---
    const navigationObserver = new MutationObserver(() => {
        tryRenderModule();
    });
    
    navigationObserver.observe(document.body, { childList: true, subtree: true });
    tryRenderModule();
    
    console.log("[Adv. Statements] Скрипт загружен и готов к работе.");

})();